# Сервис авторизации

## Функционал

- Регистрация нового пользователя
- Авторизация пользователя
- Профиль пользователя (создание, просмотр, редактирование, смена пароля)
- Выход из системы (Logout)
- Авторизация через социальные сети (Yandex, Google)
- Трассировка запросов с Jaeger
- Ограничение количества запросов
- Партиционирование таблицы пользователей или истории входов
- Открепление аккаунтов соцсетей от личного кабинета

## Технологический стек

- **Язык**: Python 3.12+
- **Фреймворк**: FastAPI
- **База данных**: PostgreSQL (с использованием SQLAlchemy и Alembic)
- **Кеширование**: Redis
- **Трассировка**: Jaeger
- **Миграции**: Alembic
- **OAuth**: Авторизация через Yandex, Google

## Установка и запуск

### 1. Клонирование репозитория

```bash
 git clone https://github.com/Mind-Insight/AuthorizationService.git
 cd AuthorizationService
```

### 2. Создание и активация виртуального окружения

```bash
python -m venv venv
source venv/bin/activate
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 4. Настройка переменных окружения

Создайте файл `.env` и добавьте в него:

```env
DB_HOST=localhost
DB_PORT=5432
DB_NAME=users
DB_USER=postgres
DB_PASSWORD=admin

REDIS_HOST=127.0.0.1
REDIS_PORT=6379

YANDEX_CLIENT_ID=your_yandex_client_id
YANDEX_CLIENT_SECRET=your_yandex_client_secret
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

### 5. Запуск сервиса

```bash
uvicorn app.main:app --reload
```

## API Эндпоинты

| Метод  | Эндпоинт | Описание |
|--------|-----------------|--------------------------------|
| POST   | `/users/register` | Регистрация пользователя |
| POST   | `/users/login` | Авторизация пользователя |
| GET    | `/auth/users` | Получение профиля пользователя |
| POST   | `/users/logout` | Выход из системы |
| POST   | `/users/me/change-password/` | Смена пароля пользователя |
|
| GET    | `/social/login/yandex` | Авторизация через Yandex |
| GET    | `/social/callback/yandex` | Callback Yandex |
| GET    | `/social/auth/me` | Получение данных о пользователе |
| GET    | `/social/auth/refresh` | Обновление токена |
| GET    | `/social/auth/logout` | Открепление соц. аккаунта |

## Архитектура

- **FastAPI** используется для создания REST API.
- **PostgreSQL** хранит данные пользователей.
- **Redis** используется для хранения токенов аутентификации.
- **Alembic** управляет миграциями БД.
- **Jaeger** собирает трассировки запросов.
- **OAuth 2.0 + OpenID** применяется для социальной авторизации.

## Партиционирование данных

Партиционирование таблицы пользователей или истории входов реализовано на основе регионов пользователей. Это позволяет эффективно масштабировать сервис и работать с миллионами записей.

## Ограничение запросов

Используется `slowapi` для ограничения частоты запросов, например, 5 запросов в минуту на получение профиля пользователя.

## Трассировка с Jaeger

Каждый запрос обрабатывается с передачей `x-request-id`, что позволяет отслеживать цепочку вызовов и анализировать производительность.
